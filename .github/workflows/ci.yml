on:
  workflow_call:
    inputs:
      cache: { required: false, type: boolean, default: true }
      publish: { required: false, type: boolean, default: false }
    secrets:
      CODECOV_TOKEN: { required: false }

env:
  DENO_DIR: .cache

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Debug
      # - { name: "ğŸ Debug Github Context", uses: "echo '${{ toJson(github) }}'" }

      # Checkout and test
      - { name: "ğŸ”½ Checkout code", uses: "actions/checkout@v4" }
      - { name: "âš™ï¸ Setup Deno", uses: "denoland/setup-deno@v2" }

      # Cache dependencies (https://docs.deno.com/runtime/reference/continuous_integration/#caching-dependencies)
      - name: "ğŸ“Œ Caching Dependencies"
        if: inputs.cache
        uses: actions/cache@v4
        with:
          path: ${{ env.DENO_DIR }}
          key: ${{ hashFiles('deno.lock') }}

      - { name: "ğŸ¨ Ensuring code is formatted correctly", run: "deno fmt --check" }
      - { name: "ğŸ§ª Running Tests", run: "deno test --allow-all --unstable-kv --coverage" }
      - { name: "ğŸ”€ Transforming Coverage Format", run: "deno coverage --lcov > cov.lcov" }

      # Upload to Codecov (see https://github.com/marketplace/actions/codecov)
      - name: "â˜‚ï¸ Upload Test Coverage"
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: cov.lcov
          fail_ci_if_error: true

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: inputs.publish && startsWith(github.ref, 'refs/tags/')
    permissions: { contents: read, id-token: write }
    steps:
      - { name: "ğŸ”½ Checkout code", uses: actions/checkout@v4 }
      - { name: "âš™ï¸ Setup Deno", uses: "denoland/setup-deno@v2" }
      - { name: "ğŸ“¦ Publish to JSR", run: "deno publish --set-version ${{ github.ref_name }} --allow-dirty" }
